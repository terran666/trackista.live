name: Deploy to Server

on:
  push:
    branches: [ main ]

permissions:
      id-token: write   # This is required for requesting the JWT
      contents: read    # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build application
      run: npm run build
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: eu-central-1
        
    - name: Deploy to S3 (Ultra Aggressive Cache Busting)
      run: |
        echo "ðŸ§¹ Ultra aggressive S3 bucket cleaning..."
        # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° S3 bucket
        aws s3 rm s3://trackista-live --recursive
        
        echo "â³ Waiting for S3 cleanup to complete..."
        sleep 10
        
        echo "ðŸš€ Deploying with timestamp-based cache busting..."
        TIMESTAMP=$(date +%s)
        
        # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð½Ð¾Ð²Ð¾ Ñ timestamp
        aws s3 sync dist/ s3://trackista-live --delete
        
        # ÐÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ SPA Ñ€Ð¾ÑƒÑ‚Ð¸Ð½Ð³Ð° ÐŸÐ•Ð Ð•Ð” ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
        echo "ðŸ”§ Creating immediate SPA route files..."
        aws s3 cp s3://trackista-live/index.html s3://trackista-live/error.html
        aws s3 cp s3://trackista-live/index.html s3://trackista-live/density
        aws s3 cp s3://trackista-live/index.html s3://trackista-live/screener  
        aws s3 cp s3://trackista-live/index.html s3://trackista-live/community
        aws s3 cp s3://trackista-live/index.html s3://trackista-live/charts
        
        # Ultra aggressive no-cache Ð´Ð»Ñ HTML Ñ„Ð°Ð¹Ð»Ð¾Ð²
        aws s3 cp dist/index.html s3://trackista-live/index.html \
          --cache-control "no-cache, no-store, must-revalidate, max-age=0, s-maxage=0, proxy-revalidate" \
          --expires "Thu, 01 Jan 1970 00:00:00 GMT" \
          --metadata-directive REPLACE \
          --metadata "timestamp=$TIMESTAMP"
        
        # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ assets Ñ ultra aggressive no-cache
        aws s3 sync dist/assets/ s3://trackista-live/assets/ \
          --cache-control "no-cache, no-store, must-revalidate, max-age=0, s-maxage=0" \
          --expires "Thu, 01 Jan 1970 00:00:00 GMT" \
          --metadata-directive REPLACE
        
        echo "ðŸ”§ Configuring S3 for SPA routing with comprehensive setup..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
        echo "ðŸ“‹ Checking build files..."
        ls -la dist/
        
        if [ -f "dist/index.html" ]; then
          echo "âœ… Found dist/index.html, setting up comprehensive SPA routing..."
          
          # 1. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ error.html Ð´Ð»Ñ S3 website configuration
          echo "ðŸ“„ Creating error.html..."
          aws s3 cp dist/index.html s3://trackista-live/error.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0, s-maxage=0, proxy-revalidate" \
            --expires "Thu, 01 Jan 1970 00:00:00 GMT" \
            --metadata-directive REPLACE
            
          # 2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð±ÐµÐ· Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€ÑÐ¼Ñ‹Ñ… URL (ÐºÐ°Ðº nginx try_files)
          echo "ï¿½ Creating direct route files..."
          aws s3 cp dist/index.html s3://trackista-live/density \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
          
          aws s3 cp dist/index.html s3://trackista-live/screener \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
            
          aws s3 cp dist/index.html s3://trackista-live/community \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
            
          aws s3 cp dist/index.html s3://trackista-live/charts \
            --content-type "text/html" \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
          
          # 3. Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ñ index.html Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
          echo "ðŸ“ Creating directory-based routes..."
          aws s3 cp dist/index.html s3://trackista-live/density/index.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
          
          aws s3 cp dist/index.html s3://trackista-live/screener/index.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
            
          aws s3 cp dist/index.html s3://trackista-live/community/index.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
            
          aws s3 cp dist/index.html s3://trackista-live/charts/index.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive REPLACE
            
        else
          echo "âŒ dist/index.html not found! Build may have failed."
          exit 1
        fi
        
        # 4. ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ð°Ñ S3 website ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
        echo "ðŸŒ Setting up simple S3 website configuration..."
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ website ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
        aws s3 website s3://trackista-live --index-document index.html --error-document index.html
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ error.html ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        aws s3 ls s3://trackista-live/error.html || aws s3 cp s3://trackista-live/index.html s3://trackista-live/error.html
        
        # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹
        echo "ðŸ” Verifying uploaded files..."
        aws s3 ls s3://trackista-live/ --human-readable
        
        # 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ website ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
        echo "ðŸ” Verifying S3 website configuration..."
        aws s3api get-bucket-website --bucket trackista-live
        
        # 7. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… SPA Ñ„Ð°Ð¹Ð»Ð¾Ð²
        echo "ðŸ”„ Final SPA routing files verification and creation..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ route Ñ„Ð°Ð¹Ð» Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚
        for route in density screener community charts; do
          echo "Checking route: /$route"
          if ! aws s3 ls s3://trackista-live/$route > /dev/null 2>&1; then
            echo "Creating missing route: /$route"
            aws s3 cp s3://trackista-live/index.html s3://trackista-live/$route \
              --content-type "text/html" \
              --cache-control "no-cache, no-store, must-revalidate, max-age=0"
          fi
        done
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ error.html
        if ! aws s3 ls s3://trackista-live/error.html > /dev/null 2>&1; then
          echo "Creating missing error.html"
          aws s3 cp s3://trackista-live/index.html s3://trackista-live/error.html \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0"
        fi
        
        echo "âœ… Deployment completed with verified SPA routing support. Timestamp: $TIMESTAMP"